<rss xmlns:atom="http://www.w3.org/2005/Atom" version="2.0"><channel><title>tproxy - 标签 - NEGOCES's Blog</title><link>https://negoces.github.io/tags/tproxy/</link><description>tproxy - 标签 - NEGOCES's Blog</description><generator>Hugo -- gohugo.io</generator><language>zh-CN</language><managingEditor>negoces@163.com (NEGOCES)</managingEditor><webMaster>negoces@163.com (NEGOCES)</webMaster><lastBuildDate>Mon, 15 Feb 2021 14:18:18 +0800</lastBuildDate><atom:link href="https://negoces.github.io/tags/tproxy/" rel="self" type="application/rss+xml"/><item><title>把树莓派当作热点并开启Tproxy</title><link>https://negoces.github.io/posts/542347b3/</link><pubDate>Mon, 15 Feb 2021 14:18:18 +0800</pubDate><author>作者</author><guid>https://negoces.github.io/posts/542347b3/</guid><description><![CDATA[<blockquote>
<p>测试环境:<br>
设备: RaspberryPi 3B+<br>
系统: raspios<br>
上级路由: 192.1681.1 (OpenWRT)</p>
</blockquote>
<h2 id="安装系统">安装系统</h2>
<p>从<a href="https://www.raspberrypi.org/software/operating-systems/" target="_blank" rel="noopener noreffer">官网</a>或者<a href="https://mirrors.tuna.tsinghua.edu.cn/raspberry-pi-os-images/" target="_blank" rel="noopener noreffer">镜像</a>下载 raspios,使用<a href="https://www.balena.io/etcher/" target="_blank" rel="noopener noreffer">BalenaEtcher</a>写入 SD 卡</p>
<p>启动并修改 apt 镜像</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback"># /etc/apt/sources.list
deb https://mirrors.sjtug.sjtu.edu.cn/debian buster main contrib non-free
deb https://mirrors.sjtug.sjtu.edu.cn/debian buster-updates main contrib non-free
deb https://mirrors.sjtug.sjtu.edu.cn/debian-security/ buster/updates main contrib non-free
deb-src https://mirrors.sjtug.sjtu.edu.cn/debian buster main contrib non-free
deb-src https://mirrors.sjtug.sjtu.edu.cn/debian buster-updates main contrib non-free
deb-src https://mirrors.sjtug.sjtu.edu.cn/debian-security/ buster/updates main contrib non-free
</code></pre></td></tr></table>
</div>
</div><div class="details admonition note">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-pencil-alt fa-fw"></i>更激进的软件更新<i class="details-icon fas fa-angle-right fa-fw"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content"><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback"># /etc/apt/sources.list
deb https://mirrors.sjtug.sjtu.edu.cn/debian testing main contrib non-free
deb https://mirrors.sjtug.sjtu.edu.cn/debian testing-updates main contrib non-free
deb https://mirrors.sjtug.sjtu.edu.cn/debian-security/ stable/updates main contrib non-free
deb-src https://mirrors.sjtug.sjtu.edu.cn/debian testing main contrib non-free
deb-src https://mirrors.sjtug.sjtu.edu.cn/debian testing-updates main contrib non-free
deb-src https://mirrors.sjtug.sjtu.edu.cn/debian-security/ stable/updates main contrib non-free
</code></pre></td></tr></table>
</div>
</div></div>
        </div>
    </div>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback"># /etc/apt/sources.list.d/raspi.list
deb https://mirrors.sjtug.sjtu.edu.cn/raspberrypi/debian/ buster main
deb-src https://mirrors.sjtug.sjtu.edu.cn/raspberrypi/debian/ buster main
</code></pre></td></tr></table>
</div>
</div><p>完全更新系统</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">sudo apt update
sudo apt full-upgrade -y
</code></pre></td></tr></table>
</div>
</div><h2 id="安装必要软件">安装必要软件</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">sudo apt install hostapd dnsmasq netfilter-persistent iptables-persistent -y
</code></pre></td></tr></table>
</div>
</div><h2 id="设置无线接口">设置无线接口</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback"># /etc/dhcpcd.conf
interface wlan0
    static ip_address=172.16.3.1/24
    nohook wpa_supplicant
</code></pre></td></tr></table>
</div>
</div><h2 id="设置系统语言可选">设置系统语言(可选)</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ini" data-lang="ini"><span class="c1"># /etc/environment</span>
<span class="na">LANG</span><span class="o">=</span><span class="s">zh_CN.UTF-8</span>
<span class="na">LANGUAGE</span><span class="o">=</span><span class="s">&#34;zh_CN:zh:en_US:en&#34;</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="开启内核转发">开启内核转发</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ini" data-lang="ini"><span class="c1"># /etc/sysctl.conf</span>
<span class="na">net.ipv4.ip_forward</span><span class="o">=</span><span class="s">1</span>
<span class="na">net.ipv6.conf.all.forwarding</span><span class="o">=</span><span class="s">1</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="配置无线国家代码">配置无线国家代码</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">sudo raspi-config
</code></pre></td></tr></table>
</div>
</div><p><code>Localisation Options -&gt; WLAN Country -&gt; AU</code></p>
<p>重启</p>
<h2 id="配置并启用hostapd">配置并启用hostapd</h2>
<p>先确保无线模块未被禁用</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">sudo rfkill unblock wlan
</code></pre></td></tr></table>
</div>
</div><p>对hostapd进行设置</p>
<p>(
查看支持的频段
sudo iw reg set GB
iw phy phy0 channels
)</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ini" data-lang="ini"><span class="c1"># /etc/hostapd/hostapd.conf</span>

<span class="c1"># 接口与频率设定</span>
<span class="na">interface</span><span class="o">=</span><span class="s">wlan0</span>
<span class="na">hw_mode</span><span class="o">=</span><span class="s">a</span>
<span class="na">channel</span><span class="o">=</span><span class="s">149</span>
<span class="na">country_code</span><span class="o">=</span><span class="s">AU</span>
<span class="na">ieee80211d</span><span class="o">=</span><span class="s">1</span>
<span class="na">macaddr_acl</span><span class="o">=</span><span class="s">0</span>
<span class="na">max_num_sta</span><span class="o">=</span><span class="s">10</span>
<span class="na">ignore_broadcast_ssid</span><span class="o">=</span><span class="s">0</span>
<span class="na">wmm_enabled</span><span class="o">=</span><span class="s">1</span>

<span class="c1"># 802.11n/ac (HT/VHT) Settings</span>
<span class="na">ieee80211n</span><span class="o">=</span><span class="s">1</span>
<span class="na">ieee80211ac</span><span class="o">=</span><span class="s">1</span>
<span class="na">ht_capab</span><span class="o">=</span><span class="s">[HT40+][SHORT-GI-20][SHORT-GI-40][DSSS_CCK-40][MAX-AMSDU-3839]</span>
<span class="na">vht_capab</span><span class="o">=</span><span class="s">[MAX-MPDU-3895][SHORT-GI-80][SU-BEAMFORMEE]</span>
<span class="na">vht_oper_chwidth</span><span class="o">=</span><span class="s">1</span>
<span class="na">vht_oper_centr_freq_seg0_idx</span><span class="o">=</span><span class="s">155</span>

<span class="c1"># SSID及安全设置</span>
<span class="na">ssid</span><span class="o">=</span><span class="s">Raspberry Net</span>
<span class="na">wpa</span><span class="o">=</span><span class="s">2</span>
<span class="na">auth_algs</span><span class="o">=</span><span class="s">1</span>
<span class="na">rsn_pairwise</span><span class="o">=</span><span class="s">CCMP</span>
<span class="na">wpa_key_mgmt</span><span class="o">=</span><span class="s">WPA-PSK</span>
<span class="na">wpa_passphrase</span><span class="o">=</span><span class="s">12345678</span>
</code></pre></td></tr></table>
</div>
</div><p>start</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">sudo systemctl unmask hostapd
sudo systemctl <span class="nb">enable</span> hostapd
sudo systemctl start hostapd
sudo systemctl status hostapd
</code></pre></td></tr></table>
</div>
</div><p>手机的WLAN列表中会扫描到，但请不要尝试连接，现在并没有配置DHCP服务，你的设备会因为没有分配到IP导致无法连接</p>
<h2 id="配置并启用dnsmasq">配置并启用dnsmasq</h2>
<p>备份原有配置</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">sudo mv /etc/dnsmasq.conf /etc/dnsmasq.conf.bak
</code></pre></td></tr></table>
</div>
</div><p>创建新配置</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback"># /etc/dnsmasq.conf
interface=wlan0
dhcp-range=172.16.3.100,172.16.3.253,255.255.255.0,2h
domain=wlan
address=/gw.wlan/172.16.3.1
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">sudo systemctl <span class="nb">enable</span> dnsmasq
sudo systemctl restart dnsmasq
sudo systemctl status dnsmasq
</code></pre></td></tr></table>
</div>
</div><h2 id="配置iptables">配置iptables</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">sudo iptables -t nat -A POSTROUTING -j MASQUERADE
</code></pre></td></tr></table>
</div>
</div><p>iptables永久化</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">sudo netfilter-persistent save
</code></pre></td></tr></table>
</div>
</div><h2 id="启用ipv6地址下发">启用IPv6地址下发</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">sudo apt install radvd -y
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback"># /etc/radvd.conf
interface wlan0 {
    AdvSendAdvert on;
	MinRtrAdvInterval 30;
	MaxRtrAdvInterval 100; 
    prefix ::/64
    {
        AdvOnLink on;
        AdvAutonomous on;   
        AdvRouterAddr off;
        AdvValidLifetime 120;
		AdvPreferredLifetime 100;
    };
};
</code></pre></td></tr></table>
</div>
</div>]]></description></item></channel></rss>